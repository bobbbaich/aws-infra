name: Deploy Infrastructure

on: workflow_dispatch

env:
  ENVIRONMENT: development
  AWS_REGION: us-east-1

jobs:
  deploy-s3:
    name: Deploy Infrastructure
    environment: development
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - id: deploy-s3
        uses: aws-actions/aws-cloudformation-github-deploy@v1.0.3
        with:
          name: ${{ env.ENVIRONMENT }}-s3
          template: stacks/s3.yaml
          no-fail-on-empty-changeset: "1"
          parameter-overrides: "EnvironmentName=${{ env.ENVIRONMENT }}"

      - id: aws-package-infrastructure-stack
        run: |
          aws cloudformation package \
            --template-file stacks/infrastructure.yaml \
            --output-template-file stacks/infrastructure.packaged.yaml \
            --s3-prefix aws-infra/stacks \
            --s3-bucket ${{ steps.deploy-s3.outputs.CloudformationBucket }}
        shell: bash

      - id: deploy-infrastructure
        uses: aws-actions/aws-cloudformation-github-deploy@v1.0.3
        with:
          name: ${{ env.ENVIRONMENT }}-infrastructure
          template: stacks/infrastructure.packaged.yaml
          no-fail-on-empty-changeset: "1"
          parameter-overrides: "EnvironmentName=${{ env.ENVIRONMENT }}"

      - id: aws-package-lambda-stack
        run: |
          aws cloudformation package \
            --template-file stacks/lambda.yaml \
            --output-template-file stacks/lambda.packaged.yaml \
            --s3-prefix aws-infra/database-setup \
            --s3-bucket ${{ steps.deploy-s3.outputs.LambdaBucket }}
        shell: bash
      - id: deploy-lambda
        uses: aws-actions/aws-cloudformation-github-deploy@v1.0.3
        with:
          name: ${{ env.ENVIRONMENT }}-lambda
          template: stacks/lambda.packaged.yaml
          capabilities: 'CAPABILITY_IAM, CAPABILITY_AUTO_EXPAND' # required by lambda
          no-fail-on-empty-changeset: "1"
          parameter-overrides: "EnvironmentName=${{ env.ENVIRONMENT }}"